#------------------------------------------------------------------------------
# GitHub Actions CI Workflow
# Continuous Integration: Validation and Testing
#------------------------------------------------------------------------------

name: Terraform CI

on:
  push:
    branches:
      - main
      - 'feature/**'
  pull_request:
    branches:
      - main

env:
  TERRAFORM_VERSION: '1.5.7'
  TERRAGRUNT_VERSION: '0.53.0'
  TFLINT_VERSION: 'v0.48.0'
  AWS_REGION: 'us-east-1'

jobs:
  #----------------------------------------------------------------------------
  # Terraform Format Check
  #----------------------------------------------------------------------------
  terraform-fmt:
    name: Terraform Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive -diff
        continue-on-error: false

  #----------------------------------------------------------------------------
  # Terraform Validate
  #----------------------------------------------------------------------------
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    needs: terraform-fmt
    strategy:
      matrix:
        module:
          - vpc
          - ecs
          - rds
          - ec2-splunk
          - secrets-manager
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: modules/${{ matrix.module }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: modules/${{ matrix.module }}

  #----------------------------------------------------------------------------
  # TFLint - Terraform Linting
  #----------------------------------------------------------------------------
  tflint:
    name: TFLint
    runs-on: ubuntu-latest
    needs: terraform-fmt
    strategy:
      matrix:
        module:
          - vpc
          - ecs
          - rds
          - ec2-splunk
          - secrets-manager
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: ${{ env.TFLINT_VERSION }}

      - name: Init TFLint
        run: tflint --init
        working-directory: modules/${{ matrix.module }}

      - name: Run TFLint
        run: tflint --format=compact
        working-directory: modules/${{ matrix.module }}

  #----------------------------------------------------------------------------
  # Checkov - Security Scanning
  #----------------------------------------------------------------------------
  checkov:
    name: Security Scan (Checkov)
    runs-on: ubuntu-latest
    needs: terraform-validate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: modules/
          framework: terraform
          output_format: cli
          soft_fail: true  # Don't fail the build, just report
          skip_check: CKV_AWS_144,CKV_AWS_145  # Skip certain checks if needed

  #----------------------------------------------------------------------------
  # Terragrunt Validate - Staging
  #----------------------------------------------------------------------------
  terragrunt-validate-staging:
    name: Terragrunt Validate (Staging)
    runs-on: ubuntu-latest
    needs: [terraform-validate, tflint]
    env:
      # Mock values for validation
      TF_VAR_db_username: "test_user"
      TF_VAR_db_password: "test_password"
      TF_VAR_splunk_admin_password: "test_password"
      TF_VAR_app_secret_key: "test_secret"
      TF_VAR_splunk_hec_token: "test_token"
      TF_VAR_docker_image: "nginx:latest"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terragrunt Validate All (Staging)
        run: terragrunt run-all validate --terragrunt-non-interactive
        working-directory: environments/us-east-1/staging

  #----------------------------------------------------------------------------
  # Terragrunt Plan - Staging
  #----------------------------------------------------------------------------
  terragrunt-plan-staging:
    name: Terragrunt Plan (Staging)
    runs-on: ubuntu-latest
    needs: terragrunt-validate-staging
    if: github.event_name == 'pull_request'
    env:
      TF_VAR_db_username: ${{ secrets.DB_USERNAME }}
      TF_VAR_db_password: ${{ secrets.DB_PASSWORD }}
      TF_VAR_splunk_admin_password: ${{ secrets.SPLUNK_ADMIN_PASSWORD }}
      TF_VAR_app_secret_key: ${{ secrets.APP_SECRET_KEY }}
      TF_VAR_splunk_hec_token: ${{ secrets.SPLUNK_HEC_TOKEN }}
      TF_VAR_docker_image: ${{ secrets.DOCKER_IMAGE }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terragrunt Plan All (Staging)
        run: terragrunt run-all plan --terragrunt-non-interactive -out=tfplan
        working-directory: environments/us-east-1/staging

      - name: Comment Plan on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const output = `#### Terraform Plan for Staging ðŸ“–
            
            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*
            
            Plan completed successfully! Review the plan in the Actions tab.
            
            > Note: This plan shows what changes will be made when merged to main and deployed via Jenkins.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  #----------------------------------------------------------------------------
  # Terragrunt Validate - Production
  #----------------------------------------------------------------------------
  terragrunt-validate-production:
    name: Terragrunt Validate (Production)
    runs-on: ubuntu-latest
    needs: [terraform-validate, tflint]
    env:
      # Mock values for validation
      TF_VAR_db_username: "test_user"
      TF_VAR_db_password: "test_password"
      TF_VAR_splunk_admin_password: "test_password"
      TF_VAR_app_secret_key: "test_secret"
      TF_VAR_splunk_hec_token: "test_token"
      TF_VAR_docker_image: "nginx:latest"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup Terragrunt
        run: |
          wget -q https://github.com/gruntwork-io/terragrunt/releases/download/v${{ env.TERRAGRUNT_VERSION }}/terragrunt_linux_amd64
          chmod +x terragrunt_linux_amd64
          sudo mv terragrunt_linux_amd64 /usr/local/bin/terragrunt

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terragrunt Validate All (Production)
        run: terragrunt run-all validate --terragrunt-non-interactive
        working-directory: environments/us-east-1/production

  #----------------------------------------------------------------------------
  # Documentation Check
  #----------------------------------------------------------------------------
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f "README.md" ]; then
            echo "ERROR: README.md not found"
            exit 1
          fi

      - name: Check for TODO comments
        run: |
          echo "Checking for TODO comments in Terraform files..."
          grep -r "TODO" modules/ --include="*.tf" || echo "No TODO comments found"

  #----------------------------------------------------------------------------
  # Summary
  #----------------------------------------------------------------------------
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [terraform-fmt, terraform-validate, tflint, checkov, terragrunt-validate-staging, terragrunt-validate-production, docs-check]
    if: always()
    steps:
      - name: CI Summary
        run: |
          echo "## CI Pipeline Summary"
          echo ""
          echo "| Check | Status |"
          echo "|-------|--------|"
          echo "| Terraform Format | ${{ needs.terraform-fmt.result }} |"
          echo "| Terraform Validate | ${{ needs.terraform-validate.result }} |"
          echo "| TFLint | ${{ needs.tflint.result }} |"
          echo "| Checkov Security Scan | ${{ needs.checkov.result }} |"
          echo "| Terragrunt Validate (Staging) | ${{ needs.terragrunt-validate-staging.result }} |"
          echo "| Terragrunt Validate (Production) | ${{ needs.terragrunt-validate-production.result }} |"
          echo "| Documentation Check | ${{ needs.docs-check.result }} |"
